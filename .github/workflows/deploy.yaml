name: Deploy Cesped365 to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite ejecutar manualmente desde GitHub

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # ========================================
      # 1. CHECKOUT DEL C√ìDIGO
      # ========================================
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      # ========================================
      # 2. CONFIGURAR NODE.JS PARA EL FRONTEND
      # ========================================
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      # ========================================
      # 3. BUILD DEL FRONTEND (Svelte)
      # ========================================
      - name: üì¶ Install frontend dependencies
        run: npm ci

      - name: üèóÔ∏è Build frontend
        run: npm run build
        env:
          NODE_ENV: production

      - name: ‚úÖ Verify build output
        run: |
          echo "=== Verificando build del frontend ==="
          
          # Verificar que dist existe
          if [ ! -d "dist" ]; then
            echo "‚ùå ERROR: carpeta dist/ no fue creada"
            exit 1
          fi
          
          # Verificar index.html
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå ERROR: dist/index.html no existe"
            exit 1
          else
            echo "‚úÖ dist/index.html existe"
          fi
          
          # Copiar .htaccess si no existe
          if [ ! -f "dist/.htaccess" ]; then
            echo "‚ö†Ô∏è  Creando .htaccess para el frontend..."
            cat > dist/.htaccess << 'EOF'
          <IfModule mod_rewrite.c>
            RewriteEngine On
            
            # Redirigir HTTP a HTTPS
            RewriteCond %{HTTPS} off
            RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]
            
            # No redirigir si es API
            RewriteCond %{REQUEST_URI} ^/api/
            RewriteRule ^ - [L]
            
            # Servir archivos est√°ticos
            RewriteCond %{REQUEST_FILENAME} -f [OR]
            RewriteCond %{REQUEST_FILENAME} -d
            RewriteRule ^ - [L]
            
            # SPA routing
            RewriteRule ^ index.html [L]
          </IfModule>
          
          <IfModule mod_headers.c>
            Header set X-Content-Type-Options "nosniff"
            Header set X-Frame-Options "SAMEORIGIN"
            Header set X-XSS-Protection "1; mode=block"
          </IfModule>
          EOF
          else
            echo "‚úÖ dist/.htaccess existe"
          fi
          
          echo ""
          echo "üìÅ Archivos en dist/:"
          ls -lah dist/ | head -20

      # ========================================
      # 4. PREPARAR BACKEND (CodeIgniter)
      # ========================================
      - name: üì¶ Verificar backend dependencies
        working-directory: ./api
        run: |
          echo "=== Verificando dependencias del backend ==="
          
          # Verificar si vendor/ existe
          if [ -d "vendor" ]; then
            echo "‚úÖ Carpeta vendor/ encontrada (${du -sh vendor/ | cut -f1})"
            echo "‚úÖ Se usar√° el vendor/ del repositorio"
          else
            echo "‚ö†Ô∏è  Carpeta vendor/ NO encontrada"
            echo "‚ö†Ô∏è  El backend necesita dependencias de Composer"
            echo "‚ö†Ô∏è  Ejecuta localmente: cd api && composer install"
            exit 1
          fi
          
          # Verificar archivos importantes
          if [ ! -f "app/Config/App.php" ]; then
            echo "‚ùå ERROR: Estructura de CodeIgniter incorrecta"
            exit 1
          fi
          
          echo "‚úÖ Backend verificado correctamente"

      - name: üîí Create backend .htaccess files
        run: |
          echo "=== Creando archivos .htaccess para el backend ==="
          
          # .htaccess en api/public/
          mkdir -p api/public
          cat > api/public/.htaccess << 'EOF'
          <IfModule mod_rewrite.c>
              Options -Indexes
              RewriteEngine On
              
              RewriteCond %{REQUEST_FILENAME} !-f
              RewriteCond %{REQUEST_FILENAME} !-d
              RewriteRule ^(.*)$ index.php/$1 [L]
          </IfModule>
          
          <IfModule !mod_rewrite.c>
              ErrorDocument 404 index.php
          </IfModule>
          
          Options -Indexes
          
          <FilesMatch "^\.">
              Order allow,deny
              Deny from all
          </FilesMatch>
          EOF
          
          # .htaccess en api/ (ra√≠z del backend)
          cat > api/.htaccess << 'EOF'
          <IfModule mod_rewrite.c>
              RewriteEngine On
              RewriteRule ^(.*)$ public/$1 [L]
          </IfModule>
          
          <FilesMatch "^\.env|composer\.(json|lock)|phpunit\.xml">
              Order allow,deny
              Deny from all
          </FilesMatch>
          
          RedirectMatch 403 ^/api/(app|writable|vendor|\.git)(/|$)
          EOF
          
          echo "‚úÖ Archivos .htaccess creados"

      - name: üóÇÔ∏è Verify backend structure
        run: |
          echo "=== Verificando estructura del backend ==="
          
          if [ ! -d "api/app" ]; then
            echo "‚ùå ERROR: api/app/ no existe"
            exit 1
          fi
          
          if [ ! -f "api/public/index.php" ]; then
            echo "‚ùå ERROR: api/public/index.php no existe"
            exit 1
          fi
          
          echo "‚úÖ Estructura del backend correcta"
          echo ""
          echo "üìÅ Estructura de api/:"
          ls -lah api/ | grep -E '^d|app|public|writable'

      # ========================================
      # 5. PREPARAR ARCHIVOS PARA DEPLOYMENT
      # ========================================
      - name: üìã Prepare deployment files
        run: |
          echo "=== Preparando archivos para deployment ==="
          
          # Crear carpeta temporal para deployment
          mkdir -p deploy_temp
          
          # Copiar frontend (dist/) a deploy_temp/
          cp -r dist/* deploy_temp/
          
          # Copiar backend (api/) a deploy_temp/api/
          mkdir -p deploy_temp/api
          
          # Copiar solo archivos necesarios del backend
          cp -r api/app deploy_temp/api/
          cp -r api/public deploy_temp/api/
          cp -r api/writable deploy_temp/api/
          
          # Copiar vendor si existe
          if [ -d "api/vendor" ]; then
            cp -r api/vendor deploy_temp/api/
          fi
          
          # Copiar archivos de configuraci√≥n del backend
          [ -f "api/spark" ] && cp api/spark deploy_temp/api/
          [ -f "api/.htaccess" ] && cp api/.htaccess deploy_temp/api/
          
          # Crear carpetas necesarias en writable/
          mkdir -p deploy_temp/api/writable/cache
          mkdir -p deploy_temp/api/writable/logs
          mkdir -p deploy_temp/api/writable/session
          mkdir -p deploy_temp/api/writable/uploads
          
          # Crear .gitkeep en carpetas vac√≠as para que se suban
          touch deploy_temp/api/writable/cache/.gitkeep
          touch deploy_temp/api/writable/logs/.gitkeep
          touch deploy_temp/api/writable/session/.gitkeep
          touch deploy_temp/api/writable/uploads/.gitkeep
          
          echo "‚úÖ Archivos preparados"
          echo ""
          echo "üìÅ Contenido de deploy_temp/:"
          ls -lah deploy_temp/
          echo ""
          echo "üìÅ Contenido de deploy_temp/api/:"
          ls -lah deploy_temp/api/

      # ========================================
      # 6. VALIDAR CONFIGURACI√ìN FTP
      # ========================================
      - name: üîç Validate FTP configuration
        run: |
          echo "=== Validando configuraci√≥n FTP ==="
          
          # Verificar FTP_SERVER
          if [ -z "${{ secrets.FTP_SERVER }}" ]; then
            echo "‚ùå ERROR: FTP_SERVER no est√° configurado"
            echo "   Ve a: Settings ‚Üí Secrets and variables ‚Üí Actions"
            exit 1
          else
            echo "‚úÖ FTP_SERVER configurado"
          fi
          
          # Verificar FTP_USERNAME
          if [ -z "${{ secrets.FTP_USERNAME }}" ]; then
            echo "‚ùå ERROR: FTP_USERNAME no est√° configurado"
            exit 1
          else
            echo "‚úÖ FTP_USERNAME configurado"
          fi
          
          # Verificar FTP_PASSWORD
          if [ -z "${{ secrets.FTP_PASSWORD }}" ]; then
            echo "‚ùå ERROR: FTP_PASSWORD no est√° configurado"
            exit 1
          else
            echo "‚úÖ FTP_PASSWORD configurado"
          fi
          
          echo ""
          echo "‚úÖ Configuraci√≥n FTP v√°lida"

      # ========================================
      # 7. DEPLOY A PRODUCCI√ìN V√çA FTP
      # ========================================
      - name: üöÄ Deploy to production server
        id: ftp-deploy
        continue-on-error: true
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          local-dir: deploy_temp/
          server-dir: ${{ secrets.FTP_SERVER_DIR || 'public_html/' }}
          dangerous-clean-slate: false # IMPORTANTE: No borrar todo el servidor
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.github/**
            **/tests/**
            **/.env.example
            **/README.md
            **/package.json
            **/package-lock.json
            **/composer.json
            **/composer.lock
            **/.editorconfig
            **/.gitignore
            **/.prettierrc
          include: |
            **/.htaccess
            deploy_temp/api/writable/.gitkeep
            deploy_temp/api/writable/cache/.gitkeep
            deploy_temp/api/writable/logs/.gitkeep
            deploy_temp/api/writable/session/.gitkeep
            deploy_temp/api/writable/uploads/.gitkeep

      # ========================================
      # 8. POST-DEPLOYMENT
      # ========================================
      - name: ‚úÖ Deployment summary
        if: always()
        run: |
          echo ""
          echo "============================================="
          if [ "${{ steps.ftp-deploy.outcome }}" == "success" ]; then
            echo "‚úÖ DEPLOYMENT EXITOSO"
          else
            echo "‚ö†Ô∏è  DEPLOYMENT COMPLETADO CON ADVERTENCIAS"
          fi
          echo "============================================="
          echo ""
          echo "üì¶ Frontend: Landing + Dashboard"
          echo "üîå Backend: API CodeIgniter"
          echo ""
          echo "üìù NOTAS IMPORTANTES:"
          echo ""
          echo "üîß Versi√≥n de PHP en servidor:"
          echo "   - GitHub Actions us√≥ PHP 8.2"
          echo "   - Aseg√∫rate de que tu servidor tenga PHP 8.2+ en cPanel"
          echo "   - Ve a: cPanel ‚Üí MultiPHP Manager ‚Üí Seleccionar PHP 8.2"
          echo ""
          echo "‚ö†Ô∏è  PASOS SIGUIENTES (MANUAL):"
          echo ""
          echo "1. Verificar PHP version en el servidor (debe ser 8.2+)"
          echo ""
          echo "2. Verificar que el archivo .env existe:"
          echo "   Ubicaci√≥n: public_html/api/.env"
          echo "   Si no existe, crearlo usando CONFIGURACION_ENV_PRODUCCION.md"
          echo ""
          echo "3. Verificar permisos de carpetas:"
          echo "   public_html/api/writable/ ‚Üí 755"
          echo "   public_html/api/writable/cache/ ‚Üí 755"
          echo "   public_html/api/writable/logs/ ‚Üí 755"
          echo "   public_html/api/writable/session/ ‚Üí 755"
          echo "   public_html/api/writable/uploads/ ‚Üí 755"
          echo ""
          echo "4. Si es la primera vez, ejecutar database_setup.sql en phpMyAdmin"
          echo ""
          echo "5. Probar el sitio:"
          echo "   üè† Landing: https://tudominio.com/"
          echo "   üîê Login: https://tudominio.com/login"
          echo "   üìä Dashboard: https://tudominio.com/dashboard/resumen"
          echo ""
          echo "============================================="
          echo ""
          if [ "${{ steps.ftp-deploy.outcome }}" != "success" ]; then
            echo "‚ö†Ô∏è  El deployment FTP tuvo problemas."
            echo "    Revisa los logs arriba para m√°s detalles."
            echo "    Posibles causas:"
            echo "    - Credenciales FTP incorrectas"
            echo "    - Servidor FTP no accesible"
            echo "    - Permisos de escritura"
            echo ""
            echo "    Puedes subir manualmente v√≠a FTP:"
            echo "    1. npm run build (local)"
            echo "    2. Subir dist/ ‚Üí public_html/"
            echo "    3. Subir api/ ‚Üí public_html/api/"
            echo ""
          fi
          echo "============================================="
