name: Deploy Landing to FTP

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      - name: Verify build output
        run: |
          echo "=== Verifying build output ==="
          if [ ! -f "dist/index.html" ]; then
            echo "❌ ERROR: dist/index.html not found!"
            exit 1
          else
            echo "✅ dist/index.html exists"
          fi
          if [ ! -f "dist/.htaccess" ]; then
            echo "⚠️  WARNING: dist/.htaccess not found, creating it..."
            cp public/.htaccess dist/.htaccess 2>/dev/null || echo "# .htaccess will be created" > dist/.htaccess
          else
            echo "✅ dist/.htaccess exists"
          fi
          echo "Files in dist/:"
          ls -la dist/ | head -20

      - name: Debug FTP Configuration
        run: |
          echo "=== Checking FTP Configuration ==="
          
          # Verificar FTP_SERVER
          if [ -z "${{ secrets.FTP_SERVER }}" ]; then
            echo "❌ ERROR: FTP_SERVER secret is not set or is empty"
            echo "   Go to: Settings → Secrets and variables → Actions"
            echo "   Create a secret named: FTP_SERVER"
            exit 1
          else
            echo "✅ FTP_SERVER is set"
            SERVER="${{ secrets.FTP_SERVER }}"
            
            # Verificar formato común incorrecto
            if [[ "$SERVER" == ftp://* ]] || [[ "$SERVER" == http://* ]] || [[ "$SERVER" == https://* ]]; then
              echo "❌ ERROR: FTP_SERVER contains protocol (ftp://, http://, https://)"
              echo "   Current format: $SERVER"
              echo "   Correct format: Remove 'ftp://' or 'http://' prefix"
              echo "   Example: If you have 'ftp://ftp.example.com', use only 'ftp.example.com'"
              exit 1
            fi
            
            if [[ "$SERVER" == *"/"* ]]; then
              echo "⚠️  WARNING: FTP_SERVER contains '/' (path)"
              echo "   Server should only be domain/IP, not include paths"
              echo "   Example: 'ftp.example.com' not 'ftp.example.com/public_html'"
            fi
            
            # Intentar resolver el DNS (advertencia, no error fatal)
            echo "Testing DNS resolution for: $SERVER"
            if nslookup "$SERVER" > /dev/null 2>&1; then
              echo "✅ DNS resolution successful"
            else
              echo "⚠️  WARNING: Cannot resolve DNS for '$SERVER' from GitHub Actions"
              echo "   This might be OK if:"
              echo "   - Server uses internal DNS"
              echo "   - FTP server is accessible via IP"
              echo "   - DNS propagation is still in progress"
              echo "   Will attempt connection anyway..."
            fi
          fi
          
          # Verificar otros secrets
          if [ -z "${{ secrets.FTP_USERNAME }}" ]; then
            echo "❌ ERROR: FTP_USERNAME secret is not set"
            exit 1
          else
            echo "✅ FTP_USERNAME is set"
          fi
          
          if [ -z "${{ secrets.FTP_PASSWORD }}" ]; then
            echo "❌ ERROR: FTP_PASSWORD secret is not set"
            exit 1
          else
            echo "✅ FTP_PASSWORD is set"
          fi
          
          PORT="${{ secrets.FTP_PORT || 21 }}"
          echo "✅ FTP_PORT: $PORT"
          echo ""
          echo "=== Configuration looks good! Proceeding with deployment... ==="

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          local-dir: dist/
          server-dir: ${{ secrets.FTP_SERVER_DIR || 'public_html/' }}
          dangerous-clean-slate: true
          include: |
            **/.htaccess
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.github/**