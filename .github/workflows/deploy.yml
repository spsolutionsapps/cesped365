name: Deploy to cPanel

on:
  push:
    branches: [ main, master ]  # Cambia segÃºn tu rama principal
  workflow_dispatch:  # Permite ejecutar manualmente

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'  # Laravel 11 requiere PHP 8.2+
        extensions: mbstring, bcmath, gd, mysql, zip

    - name: Install Composer dependencies
      run: composer install --no-dev --optimize-autoloader

    - name: Setup environment
      run: |
        cat > .env << EOF
        APP_NAME=Cesped365
        APP_ENV=production
        APP_KEY=
        APP_DEBUG=false
        APP_URL=https://cesped365.com

        LOG_CHANNEL=stack
        LOG_DEPRECATIONS_CHANNEL=null
        LOG_LEVEL=error

        DB_CONNECTION=mysql
        DB_HOST=localhost
        DB_PORT=3306
        DB_DATABASE=cespvcyi_cesped365_d
        DB_USERNAME=cespvcyi_cespvcyi_user
        DB_PASSWORD=Gojira2019!

        BROADCAST_DRIVER=log
        CACHE_DRIVER=file
        FILESYSTEM_DRIVER=local
        QUEUE_CONNECTION=sync
        SESSION_DRIVER=file
        SESSION_LIFETIME=120

        MEMCACHED_HOST=127.0.0.1

        REDIS_HOST=127.0.0.1
        REDIS_PASSWORD=null
        REDIS_PORT=6379

        MAIL_MAILER=smtp
        MAIL_HOST=mail.cesped365.com
        MAIL_PORT=587
        MAIL_USERNAME=info@cesped365.com
        MAIL_PASSWORD=tu_password_email
        MAIL_ENCRYPTION=tls
        MAIL_FROM_ADDRESS=info@cesped365.com
        MAIL_FROM_NAME=Cesped365

        AWS_ACCESS_KEY_ID=
        AWS_SECRET_ACCESS_KEY=
        AWS_DEFAULT_REGION=us-east-1
        AWS_BUCKET=
        AWS_USE_PATH_STYLE_ENDPOINT=false

        PUSHER_APP_ID=
        PUSHER_APP_KEY=
        PUSHER_APP_SECRET=
        PUSHER_APP_CLUSTER=mt1

        MIX_PUSHER_APP_KEY=
        MIX_PUSHER_APP_CLUSTER=mt1
        EOF

    - name: Generate application key
      run: php artisan key:generate

    - name: Clean .env file
      run: |
        # Remove any BOM or invisible characters
        sed -i '1s/^\xEF\xBB\xBF//' .env
        # Ensure proper line endings
        dos2unix .env || true

    - name: Optimize Laravel
      run: |
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache

    - name: Install Node dependencies
      run: npm install

    - name: Build assets
      run: npm run production

    - name: Deploy to cPanel via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./
        server-dir: ./  # Cambia si necesitas subir a un subdirectorio
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.env.example
          **/storage/logs/**
          **/tests/**
          .github/
          .gitignore
          README.md
          ISSUE_TEMPLATE.md
          REQUISITOS.md
          SETUP.md
          *.bat