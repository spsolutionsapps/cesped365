name: Deploy to cPanel

on:
  push:
    branches: [ main, master ]  # Cambia segÃºn tu rama principal
  workflow_dispatch:  # Permite ejecutar manualmente

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'  # Laravel 11 requiere PHP 8.2+
        extensions: mbstring, bcmath, gd, mysql, zip

    - name: Install Composer dependencies
      run: composer install --no-dev --optimize-autoloader

    - name: Setup environment
      run: |
        echo "APP_NAME=Cesped365" > .env
        echo "APP_ENV=production" >> .env
        echo "APP_KEY=" >> .env
        echo "APP_DEBUG=false" >> .env
        echo "APP_URL=https://cesped365.com" >> .env
        echo "" >> .env
        echo "LOG_CHANNEL=stack" >> .env
        echo "LOG_DEPRECATIONS_CHANNEL=null" >> .env
        echo "LOG_LEVEL=error" >> .env
        echo "" >> .env
        echo "DB_CONNECTION=mysql" >> .env
        echo "DB_HOST=localhost" >> .env
        echo "DB_PORT=3306" >> .env
        echo "DB_DATABASE=cespvcyi_cesped365_d" >> .env
        echo "DB_USERNAME=cespvcyi_cespvcyi_user" >> .env
        echo "DB_PASSWORD=Gojira2019!" >> .env
        echo "" >> .env
        echo "BROADCAST_DRIVER=log" >> .env
        echo "CACHE_DRIVER=file" >> .env
        echo "FILESYSTEM_DRIVER=local" >> .env
        echo "QUEUE_CONNECTION=sync" >> .env
        echo "SESSION_DRIVER=file" >> .env
        echo "SESSION_LIFETIME=120" >> .env
        echo "" >> .env
        echo "MEMCACHED_HOST=127.0.0.1" >> .env
        echo "" >> .env
        echo "REDIS_HOST=127.0.0.1" >> .env
        echo "REDIS_PASSWORD=null" >> .env
        echo "REDIS_PORT=6379" >> .env
        echo "" >> .env
        echo "MAIL_MAILER=smtp" >> .env
        echo "MAIL_HOST=mail.cesped365.com" >> .env
        echo "MAIL_PORT=587" >> .env
        echo "MAIL_USERNAME=info@cesped365.com" >> .env
        echo "MAIL_PASSWORD=tu_password_email" >> .env
        echo "MAIL_ENCRYPTION=tls" >> .env
        echo "MAIL_FROM_ADDRESS=info@cesped365.com" >> .env
        echo "MAIL_FROM_NAME=Cesped365" >> .env

    - name: Generate application key
      run: php artisan key:generate

    - name: Clean .env file
      run: |
        # Remove any BOM or invisible characters
        sed -i '1s/^\xEF\xBB\xBF//' .env
        # Ensure proper line endings
        dos2unix .env || true

    - name: Optimize Laravel (Optional - commented out due to parsing issues)
      run: |
        # php artisan config:cache
        # php artisan route:cache
        # php artisan view:cache
        echo "Skipping Laravel optimization due to .env parsing issues"

    - name: Install Node dependencies
      run: npm install

    - name: Build assets
      run: npm run production

    - name: Deploy to cPanel via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./
        server-dir: ./public_html/  # Sube a public_html
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.env.example
          **/storage/logs/**
          **/tests/**
          .github/
          .gitignore
          README.md
          ISSUE_TEMPLATE.md
          REQUISITOS.md
          SETUP.md
          *.bat