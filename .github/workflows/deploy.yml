name: Deploy to cPanel

on:
  push:
    branches: [ main, master ]  # Cambia seg√∫n tu rama principal
  workflow_dispatch:  # Permite ejecutar manualmente

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'  # Laravel 11 requiere PHP 8.2+
        extensions: mbstring, bcmath, gd, mysql, zip

    - name: Install Composer dependencies
      run: composer install --no-dev --optimize-autoloader

    - name: Setup environment
      run: |
        echo "APP_NAME=Cesped365" > .env
        echo "APP_ENV=production" >> .env
        echo "APP_KEY=" >> .env
        echo "APP_DEBUG=false" >> .env
        echo "APP_URL=https://cesped365.com" >> .env
        echo "" >> .env
        echo "LOG_CHANNEL=stack" >> .env
        echo "LOG_DEPRECATIONS_CHANNEL=null" >> .env
        echo "LOG_LEVEL=error" >> .env
        echo "" >> .env
        echo "DB_CONNECTION=mysql" >> .env
        echo "DB_HOST=localhost" >> .env
        echo "DB_PORT=3306" >> .env
        echo "DB_DATABASE=${{ secrets.DB_DATABASE }}" >> .env
        echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
        echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
        echo "" >> .env
        echo "BROADCAST_DRIVER=log" >> .env
        echo "CACHE_DRIVER=file" >> .env
        echo "FILESYSTEM_DRIVER=local" >> .env
        echo "QUEUE_CONNECTION=sync" >> .env
        echo "SESSION_DRIVER=file" >> .env
        echo "SESSION_LIFETIME=120" >> .env
        echo "" >> .env
        echo "MEMCACHED_HOST=127.0.0.1" >> .env
        echo "" >> .env
        echo "REDIS_HOST=127.0.0.1" >> .env
        echo "REDIS_PASSWORD=null" >> .env
        echo "REDIS_PORT=6379" >> .env
        echo "" >> .env
        echo "MAIL_MAILER=smtp" >> .env
        echo "MAIL_HOST=${{ secrets.MAIL_HOST }}" >> .env
        echo "MAIL_PORT=${{ secrets.MAIL_PORT }}" >> .env
        echo "MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}" >> .env
        echo "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}" >> .env
        echo "MAIL_ENCRYPTION=${{ secrets.MAIL_ENCRYPTION }}" >> .env
        echo "MAIL_FROM_ADDRESS=${{ secrets.MAIL_FROM_ADDRESS }}" >> .env
        echo "MAIL_FROM_NAME=${{ secrets.MAIL_FROM_NAME }}" >> .env

    - name: Generate application key
      run: php artisan key:generate

    - name: Clean .env file
      run: |
        # Remove any BOM or invisible characters
        sed -i '1s/^\xEF\xBB\xBF//' .env
        # Ensure proper line endings
        dos2unix .env || true

    - name: Setup storage link and permissions
      run: |
        # Create storage link for file uploads
        php artisan storage:link || echo "Storage link may already exist"

        # Set proper permissions for storage
        chmod -R 755 storage/
        chmod -R 775 storage/logs/
        chmod -R 775 storage/app/public/

        echo "Storage link and permissions configured"

    - name: Install Node dependencies
      run: npm install

    - name: Build assets
      run: npm run production

    - name: Deploy to cPanel via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        # Evita problemas con servidores que bloquean "dotfiles" (archivos que empiezan con .)
        # El action por defecto usa ".ftp-deploy-sync-state.json".
        state-name: ftp-deploy-sync-state.json
        log-level: verbose
        local-dir: ./
        # NOTE: en muchos cPanel el "FTP root" YA es public_html.
        # Si tu usuario FTP est√° chrooted a public_html, usar ./public_html/ falla con 553 (no existe).
        server-dir: ./
        dangerous-clean-slate: false
        exclude: |
          **/.git*
          **/.git*/**
          **/.cursor/**
          .cursor/
          **/node_modules/**
          **/.env.example
          **/storage/app/public/**
          **/storage/logs/**
          **/storage/framework/cache/**
          **/storage/framework/sessions/**
          **/storage/framework/views/**
          **/tests/**
          .github/
          .gitignore
          README.md
          ISSUE_TEMPLATE.md
          REQUISITOS.md
          SETUP.md
          CLEAR_CACHE_INSTRUCTIONS.md
          DOUBLE_CLICK_FIX.md
          GARDEN_REPORTS_FIX.md
          INTERMITTENT_SAVE_FIX.md
          TESTING_CHECKLIST.md
          DEPLOY_PRODUCCION.md
          clear-all-cache.bat
          INSTALACION_COMPLETA.bat
          public/check-php-limits.php
          public/test-notifications.html
          docs/**
    
    - name: Post-deployment summary
      run: |
        echo "‚úÖ Deploy completed successfully!"
        echo "üì¶ Files uploaded to production server"
        echo "‚ö†Ô∏è  IMPORTANT: Run these commands on the server:"
        echo "   cd /home/cespvcyi/public_html"
        echo "   php artisan optimize:clear"
        echo "   php artisan config:clear"
        echo "   php artisan route:clear"
        echo "   php artisan cache:clear"
        echo "   php artisan view:clear"
